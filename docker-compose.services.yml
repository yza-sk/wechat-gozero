version: '3.4'

# é€šç”¨ç¯å¢ƒå˜é‡ï¼ˆä».envæ–‡ä»¶è¯»å–ï¼‰
x-common-env: &common-env
  GO_ENV: production
  # æ ¸å¿ƒå˜é‡ï¼šä¸é…ç½®æ–‡ä»¶ä¸­çš„${å˜é‡}å¯¹åº”
  SERVER_IP: ${SERVER_IP}
  JWT_SECRET: ${JWT_SECRET}
  MYSQL_PASSWORD: ${MYSQL_PASSWORD}
  REDIS_PASSWORD: ${REDIS_PASSWORD}
  # æ–°å¢å˜é‡ï¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„æœ¬åœ°æœåŠ¡åœ°å€
  UserRpc__Endpoints: user-rpc:20001
  GroupRpc__Endpoints: group-rpc:20003
  MsgRpc__Endpoints: msg-rpc:20002
  # Kafkaé…ç½®è¦†ç›–ï¼ˆä¸msg.yaml/group.yamlä¸­çš„MqConfå¯¹åº”ï¼‰
  MqConf__Brokers: ${SERVER_IP}:9093,${SERVER_IP}:9094
  MqConf__Topic: msg_chat

services:
  # ç”¨æˆ·æœåŠ¡API
  user-api:
    build:
      context: .
      dockerfile: ./docker/api.Dockerfile
      args:
        - FULL_MODULE_PATH=user/api
        - YAML_NAME=user.yaml
    image: user-api   # ğŸ‘ˆ æ–°å¢ï¼šæ¨é€åˆ°DockerHubçš„é•œåƒå
    restart: always
    depends_on:
      - user-rpc
    environment:
      <<: *common-env
    ports:
      - "10001:10001"  # å¯¹åº”user (1).yamlçš„Port
    volumes:
      - ./app/user/api/etc:/app/etc  # æŒ‚è½½é…ç½®æ–‡ä»¶
    command: ["./api", "-f", "etc/user.yaml"]  # æ˜¾å¼æŒ‡å®šé…ç½®æ–‡ä»¶
  #    mem_reservation: 150m

  # ç”¨æˆ·æœåŠ¡RPC
  user-rpc:
    build:
      context: .
      dockerfile: ./docker/rpc.Dockerfile
      args:
        - FULL_MODULE_PATH=user/rpc
        - YAML_NAME=user.yaml
    image: user-rpc   # ğŸ‘ˆ æ–°å¢
    restart: always
    environment:
      <<: *common-env
    ports:
      - "20001:20001"  # å¯¹åº”user.yamlçš„ListenOn
    volumes:
      - ./app/user/rpc/etc:/app/etc
    command: ["./rpc", "-f", "etc/user.yaml"]
  #    mem_reservation: 100m

  # ç¾¤ç»„æœåŠ¡API
  group-api:
    build:
      context: .
      dockerfile: ./docker/api.Dockerfile
      args:
        - FULL_MODULE_PATH=group/api
        - YAML_NAME=group.yaml
    image: group-api   # ğŸ‘ˆ æ–°å¢
    restart: always
    depends_on:
      - group-rpc
    environment:
      <<: *common-env
    ports:
      - "10003:10003"  # å¯¹åº”group (1).yamlçš„Port
    volumes:
      - ./app/group/api/etc:/app/etc
    command: ["./api", "-f", "etc/group.yaml"]
  #    mem_reservation: 150m

  # ç¾¤ç»„æœåŠ¡RPC
  group-rpc:
    build:
      context: .
      dockerfile: ./docker/rpc.Dockerfile
      args:
        - FULL_MODULE_PATH=group/rpc
        - YAML_NAME=group.yaml
    image: group-rpc   # ğŸ‘ˆ æ–°å¢
    restart: always
    environment:
      <<: *common-env
    ports:
      - "20003:20003"  # å¯¹åº”group.yamlçš„ListenOn
    volumes:
      - ./app/group/rpc/etc:/app/etc
    command: ["./rpc", "-f", "etc/group.yaml"]
  #    mem_reservation: 100m

  # æ¶ˆæ¯æœåŠ¡API
  msg-api:
    build:
      context: .
      dockerfile: ./docker/api.Dockerfile
      args:
        - FULL_MODULE_PATH=msg/api
        - YAML_NAME=msg.yaml
    image: msg-api   # ğŸ‘ˆ æ–°å¢
    restart: always
    depends_on:
      - msg-rpc
      - group-rpc
    environment:
      <<: *common-env
      MqConf__Group: msg-api  # æ¶ˆæ¯æ¶ˆè´¹ç»„ï¼ˆä»…msg-apiéœ€è¦ï¼‰
    ports:
      - "10002:10002"  # å¯¹åº”msg (1).yamlçš„Port
    volumes:
      - ./app/msg/api/etc:/app/etc
    command: ["./api", "-f", "etc/msg.yaml"]
  #    mem_reservation: 150m

  # æ¶ˆæ¯æœåŠ¡RPC
  msg-rpc:
    build:
      context: .
      dockerfile: ./docker/rpc.Dockerfile
      args:
        - FULL_MODULE_PATH=msg/rpc
        - YAML_NAME=msg.yaml
    image: msg-rpc   # ğŸ‘ˆ æ–°å¢
    restart: always
    environment:
      <<: *common-env
    ports:
      - "20002:20002"  # å¯¹åº”msg.yamlçš„ListenOn
    volumes:
      - ./app/msg/rpc/etc:/app/etc
    command: ["./rpc", "-f", "etc/msg.yaml"]
#    mem_reservation: 100m

#networks:
#  wechat-gozero-network:
#    external: true  # ä¸ç¯å¢ƒæœåŠ¡ç½‘ç»œå…±äº«
